<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://corsproxy.io https://api.allorigins.win; img-src 'self' data:;">
  <title>Portfolio Backtester v8.0 (UI Overhaul)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
  <script src="app.js" defer></script>
  <style>
    :root {
      /* Color Palette */
      --c-primary: #007aff; --c-primary-hover: #005ecb; --c-border: #dee2e6;
      --c-bg-main: #f0f2f5; --c-bg-card: #ffffff; --c-bg-subtle: #f8f9fa;
      --c-text-main: #212529; --c-text-light: #6c757d; --c-error: #d93025;
      --c-success: #34c759; --c-danger: #ff3b30; --c-white: #ffffff;
      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --fs-base: 16px;
      --fs-sm: 0.875rem; /* 14px */
      --fs-xs: 0.75rem;  /* 12px */
      --fs-lg: 1.125rem; /* 18px */
      --fs-xl: 1.25rem;  /* 20px */
      --fs-h1: clamp(1.75rem, 4vw, 2.25rem); /* Fluid H1 */
      --fs-h2: clamp(1.25rem, 3vw, 1.5rem);  /* Fluid H2 */
      /* Spacing Scale */
      --space-xs: 0.25rem; /* 4px */
      --space-sm: 0.5rem;  /* 8px */
      --space-md: 1rem;    /* 16px */
      --space-lg: 1.5rem;  /* 24px */
      --space-xl: 2rem;    /* 32px */
      /* Borders & Shadows */
      --border-radius: 8px;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.07);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-sans); font-size: var(--fs-base);
      background-color: var(--c-bg-main); color: var(--c-text-main);
      margin: 0; padding-bottom: var(--space-xl);
    }
    main { display: block; }
    .app-container { max-width: 1200px; margin: 0 auto; padding: var(--space-sm); }
    h1, h2, h3 { color: var(--c-text-main); margin: 0; }
    h1 { font-size: var(--fs-h1); margin-bottom: var(--space-xs); text-align: center; }
    h2 { font-size: var(--fs-h2); padding-bottom: var(--space-md); border-bottom: 1px solid var(--c-border); }
    h3 { font-size: var(--fs-lg); margin-top: var(--space-lg); }
    .version { font-size: var(--fs-sm); color: var(--c-text-light); text-align: center; margin-bottom: var(--space-lg); }
    
    .card {
      background: var(--c-bg-card); border-radius: var(--border-radius);
      padding: var(--space-lg); margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-sm);
    }
    .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--space-md); }
    .control-group { display: flex; flex-direction: column; gap: var(--space-sm); }
    .control-group label { font-weight: 600; font-size: var(--fs-sm); display: flex; align-items: center; gap: var(--space-sm); }
    .form-control {
      width: 100%; font-size: 1rem; padding: 0.75em 1em;
      border-radius: var(--border-radius); border: 1px solid var(--c-border);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-control:focus { outline: none; border-color: var(--c-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary) 20%, transparent); }
    
    .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); font-weight: 500; font-size: var(--fs-sm); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius); text-decoration: none; transition: all 0.2s; }
    .btn--primary { background-color: var(--c-primary); color: var(--c-white); border: 1px solid var(--c-primary); }
    .btn--primary:hover { background-color: var(--c-primary-hover); }
    .btn--primary:disabled { background-color: color-mix(in srgb, var(--c-primary) 50%, var(--c-bg-subtle)); border-color: transparent; cursor: not-allowed; }
    .btn--secondary { background-color: var(--c-white); color: var(--c-text-main); border: 1px solid var(--c-border); }
    .btn--secondary:hover { background-color: var(--c-bg-subtle); }
    .btn--icon { padding: var(--space-sm); line-height: 1; }
    .btn--icon svg { width: 16px; height: 16px; }
    
    .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background-color: var(--c-bg-subtle); color: var(--c-text-light); border: 1px solid var(--c-border); font-size: var(--fs-xs); font-weight: bold; cursor: help; user-select: none; flex-shrink: 0; }
    #master-tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s, visibility 0.2s; position: fixed; width: 260px; background-color: #343a40; color: #fff; text-align: left; border-radius: 6px; padding: 10px; z-index: 1000; pointer-events: none; font-size: 13px; line-height: 1.5; }
    
    #portfolios-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-md); }
    .portfolio-card { border-radius: var(--border-radius); padding: var(--space-md); background: var(--c-bg-subtle); border: 1px solid var(--c-border); }
    .portfolio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); gap: var(--space-sm); }
    .portfolio-name-input { font-size: var(--fs-lg); font-weight: bold; border: none; background: transparent; padding: var(--space-sm); width: 100%; border-radius: var(--border-radius); }
    .portfolio-name-input:focus { background-color: var(--c-white); outline: 1px solid var(--c-border); }
    .ticker-input-row { display: flex; gap: var(--space-sm); margin-bottom: var(--space-sm); align-items: center; }
    .ticker-input { text-transform: uppercase; flex-grow: 1; }
    .allocation-input { max-width: 80px; }
    
    .run-button-container { display: flex; justify-content: center; align-items: center; gap: var(--space-md); margin: var(--space-xl) 0; }
    #run-backtest-btn, #run-projections-btn { font-size: 1rem; padding: var(--space-md) var(--space-xl); }
    .loader { display: none; width: 24px; height: 24px; border: 3px solid var(--c-primary); border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    
    .info-box, #error-container { padding: var(--space-md) var(--space-lg); margin: var(--space-md) auto; max-width: 1160px; border-radius: var(--border-radius); text-align: left; font-size: var(--fs-sm); font-weight: 500; }
    #error-container { color: var(--c-error); text-align: center; }
    .info-box { background-color: var(--warn-bg); border: 1px solid var(--warn-border); color: var(--warn-text); }
    .info-box ul { margin: 0; padding-left: var(--space-lg); }
    
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; }
    .table-container::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 30px; background: linear-gradient(to right, transparent, var(--c-bg-card)); pointer-events: none; opacity: 0; transition: opacity 0.2s; }
    .table-container.is-scrolling::after { opacity: 1; }
    table { border-collapse: collapse; width: 100%; margin: var(--space-md) 0; }
    th, td { border: 1px solid var(--c-border); padding: var(--space-sm) var(--space-md); text-align: right; font-size: var(--fs-sm); white-space: nowrap; vertical-align: middle; }
    th { background: var(--c-bg-subtle); font-weight: 600; text-align: center; }
    td:first-child, th:first-child { text-align: left; font-weight: bold; }
    .positive { color: var(--c-success); } .negative { color: var(--c-danger); }
    .hidden { display: none; }

    details.card { padding: 0; overflow: hidden; }
    details > summary { cursor: pointer; padding: var(--space-lg); list-style: none; display: flex; justify-content: space-between; align-items: center; }
    details > summary::-webkit-details-marker { display: none; }
    details > summary::after { content: '▼'; font-size: 0.8em; transform-origin: center; transition: transform 0.2s; }
    details[open] > summary::after { transform: rotate(180deg); }
    details .card__content { padding: 0 var(--space-lg) var(--space-lg); }
    
    footer { text-align: center; font-size: var(--fs-xs); color: var(--c-text-light); margin: var(--space-xl) auto; padding: var(--space-lg); max-width: 800px; border-top: 1px solid var(--c-border); line-height: 1.6; }

    @media (max-width: 768px) {
      .app-container { padding: var(--space-xs); } .card { padding: var(--space-md); }
      #setup-card .controls-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
      #setup-card .controls-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="master-tooltip"></div>
  <main class="app-container">
    <header>
      <h1>Portfolio Backtester</h1>
      <p class="version">v8.0 (UI Overhaul)</p>
    </header>

    <div id="setup-card" class="card">
      <h2 style="margin-bottom: var(--space-lg);">1. Backtest Setup</h2>
      <div class="controls-grid">
        <div class="control-group"><label for="start-date">Start Date <span class="help-icon" data-tooltip="The first day included in the historical test period. The actual start may be adjusted if an asset was created after this date.">?</span></label><input type="date" id="start-date" value="2004-01-01" class="form-control"></div>
        <div class="control-group"><label for="end-date">End Date <span class="help-icon" data-tooltip="The last day included in the historical test period.">?</span></label><input type="date" id="end-date" class="form-control"></div>
        <div class="control-group"><label for="initial-investment">Initial Investment ($) <span class="help-icon" data-tooltip="The starting amount of money in your portfolio on the Start Date.">?</span></label><input type="number" id="initial-investment" value="100000" class="form-control"></div>
        <div class="control-group"><label for="contribution-amount">Contribution Amount ($) <span class="help-icon" data-tooltip="The amount of new money you add to your portfolio at each interval.">?</span></label><input type="number" id="contribution-amount" value="400" class="form-control"></div>
        <div class="control-group"><label for="contribution-frequency">Contribution Frequency <span class="help-icon" data-tooltip="How often you add new money to your portfolio.">?</span></label><select id="contribution-frequency" class="form-control"><option value="weekly" selected>Weekly</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annually">Annually</option><option value="none">None</option></select></div>
        <div class="control-group"><label for="rebalance-frequency">Rebalance Frequency <span class="help-icon" data-tooltip="How often the portfolio is reset to its original target allocation. This involves selling winners and buying losers.">?</span></label><select id="rebalance-frequency" class="form-control"><option value="annually" selected>Annually</option><option value="quarterly">Quarterly</option><option value="never">Never</option></select></div>
        <div class="control-group"><label for="reinvest-dividends">Reinvest Dividends? <span class="help-icon" data-tooltip="Choose whether cash from dividends is automatically used to buy more shares or held as cash.">?</span></label><select id="reinvest-dividends" class="form-control"><option value="true" selected>True</option><option value="false">False</option></select></div>
        <div class="control-group"><label for="risk-free-rate">Risk-Free Rate (%) <span class="help-icon" data-tooltip="Used for Sharpe/Sortino ratios. The US 3-Month T-bill is the academic standard (e.g., ~4-5%). Defaulting to 0% is common for simplicity.">?</span></label><input type="number" id="risk-free-rate" value="0" class="form-control"></div>
        <div class="control-group"><label for="dividend-tax-rate">Dividend Tax Rate (%) <span class="help-icon" data-tooltip="The tax rate applied to dividends received. Set to 0 for tax-advantaged accounts like an IRA or 401(k).">?</span></label><input type="number" id="dividend-tax-rate" value="0" class="form-control"></div>
        <div class="control-group"><label for="gains-tax-rate">Capital Gains Tax (%) <span class="help-icon" data-tooltip="The tax rate applied to profits when assets are sold during rebalancing. Set to 0 for tax-advantaged accounts.">?</span></label><input type="number" id="gains-tax-rate" value="0" class="form-control"></div>
        <div class="control-group"><label for="benchmark1">Benchmark 1 <span class="help-icon" data-tooltip="A market index (like SPY for the S&P 500) to compare your portfolio's performance against.">?</span></label><input type="text" id="benchmark1" value="SPY" class="form-control"></div>
        <div class="control-group"><label for="benchmark2">Benchmark 2 <span class="help-icon" data-tooltip="A second market index to include for comparison.">?</span></label><input type="text" id="benchmark2" value="QQQ" class="form-control"></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: var(--space-lg);">2. Configure Portfolios</h2>
      <div id="portfolios-container"></div>
      <button id="add-portfolio-btn" class="btn btn--primary" style="margin-top: 15px;">+ Add Portfolio</button>
    </div>

    <div class="run-button-container">
        <button id="run-backtest-btn" class="btn btn--primary">Run Backtest</button>
        <div id="loader" class="loader"></div>
    </div>
    <div id="error-container"></div>
    <div id="info-container" class="info-box hidden"></div>
    <div id="backtest-debug-container" class="debug-log hidden"><h4>Backtest Debug Log:</h4></div>

    <div id="results-area" class="hidden">
      <div class="card" style="padding-bottom: 5px;"><h2>3. Backtest Results</h2></div>
      <details class="card" open><summary><h2>Capital Snapshot</h2></summary><div id="snapshot-table-container" class="card__content table-container"></div></details>
      <details class="card" open><summary><h2>Risk & Volatility</h2></summary><div id="risk-table-container" class="card__content table-container"></div></details>
      <details class="card"><summary><h2>Drawdowns</h2></summary><div id="drawdown-table-container" class="card__content table-container"></div></details>
      <details class="card"><summary><h2>Asset Allocation</h2></summary><div id="allocation-table-container" class="card__content table-container"></div></details>
      <details class="card"><summary><h2>Income & Yield</h2></summary><div id="income-table-container" class="card__content table-container"></div></details>
      <details class="card"><summary><h2>Costs & Efficiency</h2></summary><div id="costs-table-container" class="card__content table-container"></div></details>
      <details class="card"><summary><h2>Consistency</h2></summary><div id="consistency-table-container" class="card__content table-container"></div></details>
      <details class="card" open><summary><h2>Holdings Breakdown</h2></summary><div id="holdings-tables-container" class="card__content"></div></details>
    </div>

    <div id="projections-area" class="card hidden">
        <h2>4. Future Projections</h2>
        <div id="projection-warning-container" class="info-box hidden"></div>
        <div class="controls-grid" style="margin-top: var(--space-lg);">
            <div class="control-group">
                <label for="projection-goal">What is your goal? <span class="help-icon" data-tooltip="Choose a goal. Projections use the historical return and volatility from the backtest as the baseline for the simulation.">?</span></label>
                <select id="projection-goal" class="form-control">
                    <option value="grow" selected>Continue saving and grow my portfolio</option>
                    <option value="retire">Plan for a future retirement income</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sim-quality">Simulation Quality <span class="help-icon" data-tooltip="The number of possible future scenarios we will test. 'Recommended' offers a good balance of speed and accuracy.">?</span></label>
                <select id="sim-quality" class="form-control">
                    <option value="1000">Fast</option>
                    <option value="5000" selected>Recommended</option>
                    <option value="10000">High Precision</option>
                </select>
            </div>
        </div>
        <div id="grow-settings" style="margin-top: var(--space-lg);">
            <div class="controls-grid">
                <div class="control-group"><label for="grow-projection-period">Projection Period (Years) <span class="help-icon" data-tooltip="How many years into the future you want to simulate (1–100).">?</span></label><input type="number" id="grow-projection-period" value="10" class="form-control"></div>
                <div class="control-group"><label for="grow-inflation-rate">Assumed Annual Inflation (%) <span class="help-icon" data-tooltip="Used to show results in ‘today’s dollars.’ Leave 0% for nominal results.">?</span></label><input type="number" id="grow-inflation-rate" value="0" class="form-control"></div>
                <div class="control-group"><label for="grow-contribution-increase">Annual Contribution Increase (%) <span class="help-icon" data-tooltip="If your savings grow each year, add a percent here; leave 0% to keep deposits flat.">?</span></label><input type="number" id="grow-contribution-increase" value="0" class="form-control"></div>
            </div>
        </div>
        <div id="retire-settings" class="hidden" style="margin-top: var(--space-lg);">
            <div class="control-group"><label for="current-age">What is your current age? <span class="help-icon" data-tooltip="Your current age. This is used as the starting point for retirement projections.">?</span></label><input type="number" id="current-age" value="30" class="form-control"></div>
            <h3 style="margin-bottom: var(--space-md);">Phase 1: Your Working Years (Saving)</h3>
            <div class="controls-grid">
                 <div class="control-group"><label for="retirement-age">At what age do you want to retire? <span class="help-icon" data-tooltip="The age you plan to stop working and start drawing an income from your portfolio.">?</span></label><input type="number" id="retirement-age" value="65" class="form-control"></div>
                 <div class="control-group"><label for="retire-contribution-increase">Annual Saving Increase (%) <span class="help-icon" data-tooltip="If your savings grow each year, add a percent here; leave 0% to keep deposits flat.">?</span></label><input type="number" id="retire-contribution-increase" value="0" class="form-control"></div>
            </div>
            <h3 style="margin-bottom: var(--space-md);">Phase 2: Your Retirement Years (Income)</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="withdrawal-strategy">Retirement income plan? <span class="help-icon" data-tooltip="Choose how you want to receive your income in retirement.">?</span></label>
                    <select id="withdrawal-strategy" class="form-control">
                        <option value="dividends">Live Off Dividend Income Only</option>
                        <option value="fixed_amount" selected>Withdraw a Fixed Amount Annually</option>
                        <option value="percentage">Withdraw a Percentage Annually</option>
                    </select>
                </div>
                <div class="control-group"><label for="final-age">How long should income last? <span class="help-icon" data-tooltip="The age until which you need your retirement income to last.">?</span></label><input type="number" id="final-age" value="95" class="form-control"></div>
            </div>
            <div class="indented-settings">
                <div class="control-group hidden" id="fixed_amount_setting"><label for="annual-withdrawal-amount">Annual Withdrawal Amount ($) <span class="help-icon" data-tooltip="The amount of money you plan to withdraw each year for living expenses in retirement.">?</span></label><input type="number" id="annual-withdrawal-amount" value="50000" class="form-control"></div>
                <div class="control-group hidden" id="percentage_setting"><label for="annual-withdrawal-rate">Annual Withdrawal Rate (%) <span class="help-icon" data-tooltip="Typical rule-of-thumb is 4%. Higher % = higher risk of running out of money.">?</span></label><input type="number" id="annual-withdrawal-rate" value="4" class="form-control"></div>
            </div>
             <div class="control-group" style="margin-top: var(--space-md);">
                <label for="retire-inflation-rate">Assumed Annual Inflation (%) <span class="help-icon" data-tooltip="Used to show results in ‘today’s dollars.’ Leave 0% for nominal results.">?</span></label><input type="number" id="retire-inflation-rate" value="0" class="form-control">
            </div>
        </div>
        <div class="run-button-container">
            <button id="run-projections-btn" class="btn btn--primary" disabled>Run Projections</button>
            <div id="projections-loader" class="loader"></div>
        </div>
        <div id="projection-debug-container" class="debug-log hidden"><h4>Projection Debug Log:</h4></div>
        <div id="projections-results-area" class="hidden" style="margin-top: var(--space-md);"></div>
        <div id="projection-chart-container" class="hidden"><div style="width: 100%; max-width: 900px; margin: auto; padding-bottom: var(--space-md);"><canvas id="projection-chart"></canvas></div></div>
    </div>
    <footer>
        <p><strong>Disclaimer:</strong> This tool is for informational and illustrative purposes only. The results are based on historical data and Monte Carlo simulations, which are not guarantees of future performance. Past performance is not indicative of future results. All investments involve risk and may lose value.</p>
        <p>Market data is fetched via public CORS proxies and may be delayed or unavailable at times. Do not base real-world financial decisions solely on this tool.</p>
    </footer>
  </main>
</body>
</html>
